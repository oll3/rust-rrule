use chrono::{DateTime, TimeZone};
use criterion::{black_box, criterion_group, criterion_main, Criterion};
use rrule::{Frequency, NWeekday, RRule, RRuleSet, Tz, Weekday};

fn ymd_hms(year: i32, month: u32, day: u32, hour: u32, minute: u32, second: u32) -> DateTime<Tz> {
    Tz::Tz(chrono_tz::Tz::UTC)
        .with_ymd_and_hms(year, month, day, hour, minute, second)
        .unwrap()
}

fn exrule(c: &mut Criterion) {
    let mut group = c.benchmark_group("exrule");
    group.throughput(criterion::Throughput::Elements(1));

    let dt_start = ymd_hms(1960, 1, 4, 9, 0, 0);

    group.bench_function("exrule", |b| {
        let rrule = RRule {
            freq: Frequency::Daily,
            count: None,
            ..Default::default()
        }
        .validate(dt_start)
        .unwrap();

        let exrule = RRule {
            freq: Frequency::Daily,
            count: None,
            by_hour: vec![9],
            by_weekday: vec![NWeekday::Every(Weekday::Mon), NWeekday::Every(Weekday::Thu)],
            ..Default::default()
        }
        .validate(dt_start)
        .unwrap();

        let set = RRuleSet::new(dt_start).exrule(exrule).rrule(rrule);

        b.iter(|| {
            for date in set.into_iter().take(20_000) {
                black_box(date);
            }
        })
    });
    group.finish();
}

fn exdates(c: &mut Criterion) {
    let mut group = c.benchmark_group("exdates");
    group.throughput(criterion::Throughput::Elements(1));

    let exdates = [
        -29430000, -29343600, -29257200, -29170800, -29084400, -28998000, -28911600, -28825200,
        -28738800, -28652400, -28566000, -28479600, -28393200, -28306800, -28220400, -28134000,
        -28047600, -27961200, -27874800, -27788400, -27702000, -27615600, -27529200, -27442800,
        -27356400, -27270000, -27183600, -27097200, -27010800, -26924400, -26838000, -26751600,
        -26665200, -26578800, -26492400, -26406000, -26319600, -26233200, -26146800, -26060400,
        -25974000, -25887600, -25801200, -25714800, -25628400, -25542000, -25455600, -25369200,
        -25282800, -25196400, -25110000, -25023600, -24937200, -24850800, -24764400, -24678000,
        -24591600, -24505200, -24418800, -24332400, -24246000, -24159600, -24073200, -23986800,
        -23900400, -23814000, -23727600, -23641200, -23554800, -23468400, -23382000, -23295600,
        -23209200, -23122800, -23036400, -22950000, -22863600, -22777200, -22690800, -22604400,
        -22518000, -22431600, -22345200, -22258800, -22172400, -22086000, -21999600, -21913200,
        -21826800, -21740400, -21654000, -21567600, -21481200, -21394800, -21308400, -21222000,
        -21135600, -21049200, -20962800, -20876400, -20790000, -20703600, -20617200, -20530800,
        -20444400, -20358000, -20271600, -20185200, -20098800, -20012400, -19926000, -19839600,
        -19753200, -19666800, -19580400, -19494000, -19407600, -19321200, -19234800, -19148400,
        -19062000, -18975600, -18889200, -18802800, -18716400, -18630000, -18543600, -18457200,
        -18370800, -18284400, -18198000, -18111600, -18025200, -17938800, -17852400, -17766000,
        -17679600, -17593200, -17506800, -17420400, -17334000, -17247600, -17161200, -17074800,
        -16988400, -16902000, -16815600, -16729200, -16642800, -16556400, -16470000, -16383600,
        -16297200, -16210800, -16124400, -16038000, -15951600, -15865200, -15778800, -15692400,
        -15606000, -15519600, -15433200, -15346800, -15260400, -15174000, -15087600, -15001200,
        -14914800, -14828400, -14742000, -14655600, -14569200, -14482800, -14396400, -14310000,
        -14223600, -14137200, -14050800, -13964400, -13878000, -13791600, -13705200, -13618800,
        -13532400, -13446000, -13359600, -13273200, -13186800, -13100400, -13014000, -12927600,
        -12841200, -12754800, -12668400, -12582000, -12495600, -12409200, -12322800, -12236400,
        -12150000, -12063600, -11977200, -11890800, -11804400, -11718000, -11631600, -11545200,
        -11458800, -11372400, -11286000, -11199600, -11113200, -11026800, -10940400, -10854000,
        -10767600, -10681200, -10594800, -10508400, -10422000, -10335600, -10249200, -10162800,
        -10076400, -9990000, -9903600, -9817200, -9730800, -9644400, -9558000, -9471600, -9385200,
        -9298800, -9212400, -9126000, -9039600, -8953200, -8866800, -8780400, -8694000, -8607600,
        -8521200, -8434800, -8348400, -8262000, -8175600, -8089200, -8002800, -7916400, -7830000,
        -7743600, -7657200, -7570800, -7484400, -7398000, -7311600, -7225200, -7138800, -7052400,
        -6966000, -6879600, -6793200, -6706800, -6620400, -6534000, -6447600, -6361200, -6274800,
        -6188400, -6102000, -6015600, -5929200, -5842800, -5756400, -5670000, -5583600, -5497200,
        -5410800, -5324400, -5238000, -5151600, -5065200, -4978800, -4892400, -4806000, -4719600,
        -4633200, -4546800, -4460400, -4374000, -4287600, -4201200, -4114800, -4028400, -3942000,
        -3855600, -3769200, -3682800, -3596400, -3510000, -3423600, -3337200, -3250800, -3164400,
        -3078000, -2991600, -2905200, -2818800, -2732400, -2646000, -2559600, -2473200, -2386800,
        -2300400, -2214000, -2127600, -2041200, -1954800, -1868400, -1782000, -1695600, -1609200,
        -1522800, -1436400, -1350000, -1263600, -1177200, -1090800, -1004400, -918000, -831600,
        -745200, -658800, -572400, -486000, -399600, -313200, -226800, -140400, -54000, 32400,
        118800, 205200, 291600, 378000, 464400, 550800, 637200, 723600, 810000, 896400, 982800,
        1069200, 1155600, 1242000, 1328400, 1414800, 1501200, 1587600, 1674000, 1760400, 1846800,
        1933200, 2019600, 2106000, 2192400, 2278800, 2365200, 2451600, 2538000, 2624400, 2710800,
        2797200, 2883600, 2970000, 3056400, 3142800, 3229200, 3315600, 3402000, 3488400, 3574800,
        3661200, 3747600, 3834000, 3920400, 4006800, 4093200, 4179600, 4266000, 4352400, 4438800,
        4525200, 4611600, 4698000, 4784400, 4870800, 4957200, 5043600, 5130000, 5216400, 5302800,
        5389200, 5475600, 5562000, 5648400, 5734800, 5821200, 5907600, 5994000, 6080400, 6166800,
        6253200, 6339600, 6426000, 6512400, 6598800, 6685200, 6771600, 6858000, 6944400, 7030800,
        7117200, 7203600, 7290000, 7376400, 7462800, 7549200, 7635600, 7722000, 7808400, 7894800,
        7981200, 8067600, 8154000, 8240400, 8326800, 8413200, 8499600, 8586000, 8672400, 8758800,
        8845200, 8931600, 9018000, 9104400, 9190800, 9277200, 9363600, 9450000, 9536400, 9622800,
        9709200, 9795600, 9882000, 9968400, 10054800, 10141200, 10227600, 10314000, 10400400,
        10486800, 10573200, 10659600, 10746000, 10832400, 10918800, 11005200, 11091600, 11178000,
        11264400, 11350800, 11437200, 11523600, 11610000, 11696400, 11782800, 11869200, 11955600,
        12042000, 12128400, 12214800, 12301200, 12387600, 12474000, 12560400, 12646800, 12733200,
        12819600, 12906000, 12992400, 13078800, 13165200, 13251600, 13338000, 13424400, 13510800,
        13597200, 13683600, 13770000, 13856400, 13942800, 14029200, 14115600, 14202000, 14288400,
        14374800, 14461200, 14547600, 14634000, 14720400, 14806800, 14893200, 14979600, 15066000,
        15152400, 15238800, 15325200, 15411600, 15498000, 15584400, 15670800, 15757200, 15843600,
        15930000, 16016400, 16102800, 16189200, 16275600, 16362000, 16448400, 16534800, 16621200,
        16707600, 16794000, 16880400, 16966800, 17053200, 17139600, 17226000, 17312400, 17398800,
        17485200, 17571600, 17658000, 17744400, 17830800, 17917200, 18003600, 18090000, 18176400,
        18262800, 18349200, 18435600, 18522000, 18608400, 18694800, 18781200, 18867600, 18954000,
        19040400, 19126800, 19213200, 19299600, 19386000, 19472400, 19558800, 19645200, 19731600,
        19818000, 19904400, 19990800, 20077200, 20163600, 20250000, 20336400, 20422800, 20509200,
        20595600, 20682000, 20768400, 20854800, 20941200, 21027600, 21114000, 21200400, 21286800,
        21373200, 21459600, 21546000, 21632400, 21718800, 21805200, 21891600, 21978000, 22064400,
        22150800, 22237200, 22323600, 22410000, 22496400, 22582800, 22669200, 22755600, 22842000,
        22928400, 23014800, 23101200, 23187600, 23274000, 23360400, 23446800, 23533200, 23619600,
        23706000, 23792400, 23878800, 23965200, 24051600, 24138000, 24224400, 24310800, 24397200,
        24483600, 24570000, 24656400, 24742800, 24829200, 24915600, 25002000, 25088400, 25174800,
        25261200, 25347600, 25434000, 25520400, 25606800, 25693200, 25779600, 25866000, 25952400,
        26038800, 26125200, 26211600, 26298000, 26384400, 26470800, 26557200, 26643600, 26730000,
    ];

    group.bench_function("exdates", |b| {
        let dt_start = ymd_hms(1960, 1, 4, 9, 0, 0);

        let rrule = RRule {
            freq: Frequency::Daily,
            count: None,
            by_hour: vec![9],
            ..Default::default()
        }
        .validate(dt_start)
        .unwrap();

        let set = RRuleSet::new(dt_start).rrule(rrule).set_exdates(
            exdates
                .into_iter()
                .map(|t| {
                    DateTime::from_timestamp(t, 0)
                        .unwrap()
                        .with_timezone(&Tz::Tz(chrono_tz::Tz::UTC))
                })
                .collect(),
        );

        b.iter(|| {
            for date in set.into_iter().take(10_000) {
                black_box(date);
            }
        })
    });
    group.finish();
}

criterion_group!(benches, exrule, exdates);
criterion_main!(benches);
